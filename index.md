# 組込みシステム総論
## 目次
- [組込みシステム](#content1)
  - [ハードウェア構成](#content2)
  - [組込みシステム](#content3)
  - [プロセッサ](#content4)
  - [特性](#content5)
  - [利点](#content6)


<a id="content1"></a>
## 組込みシステム
- PCの様な形はしていないが、機器に組み込まれるコンピュータ。
  - ハードウェアもソフトウェアも取り外すことはできない。
  - 日常、目にする電気で動作する機器はコンピュータで制御されている。
    - スイッチ、センサなどの入力が多数搭載されている。
    - CPUが演算処理を行う。
    - デジタル信号を外部の出力装置に出力したり、アクチュエーターを使った物理的動作を行う。

<a id="content2"></a>
## 組込みシステムのハードウェア構成
- 基本的な内部構成はPC用のハードウェア構成と変わりはない。
  - コンピュータの五大装置
    - 演算装置・制御装置→CPU
    - 記憶装置→手記憶装置、補助記憶装置
    - 入力装置→スイッチ、タッチパネル、センサー
    - 出力装置→表示装置(LCD・LED)、アクチュエーター、サーボモーター
    - 入出力装置
      - 通信装置→有線・無線LAN、USB
 
<a id="content3"></a>
## 組込みシステム(Embedded System)
- 専用化されたコンピュータシステム
  - 整合個数は、数個から数100万個
  - 一つの製品に複数のCPUを使うことがある。
    - 自動車には、20〜100個のCPU(ECU)が使われている。
-組込みの応用システム(アプリケーションシステム)
  - スマートフォン(携帯電話)、タブレット、自動車、炊飯器、クーラー等、範囲は広い。

<a id="content4"></a>
## 組込みシステム(プロセッサ)
- 組込みシステム(プロセッサ)が広く使われている理由
  - 汎用性があるため、組込むプログラムにより、全く異なった製品を作ることができる。
  - プログラムの変更で、設計ミスに対応できる。
    - ただし、出荷後では、多額の費用がかかることがある。
  - 組込みシステムで専用回路をソフトウェア化する。
    - 専用回路と同じ動作をさせることが可能である。
    - 回路部品や機構部品の点数を大幅に削減できる。
- 専用回路で十分な機器もある。
  - 個別に開発すると時間がかかる。
  - 設計にミスがあっても変更が容易ではない。

<a id="content5"></a>
## 組込みシステムの特性
- 専用化されたシステムである。
- 低コストであることが必要である。
- 厳しいリソース制約がある。
  - メモリ容量、重量、サイズ、消費電力
- 高信頼性が要求されている。
  - システム改修に高いコストがかかる。
- リアルタイム性が要求されている。

<a id="content6"></a>
## 組込みシステムの利点
- コスト低減化と高機能化
- 小型・高信頼性・省電力
- 保守性の向上
  - 機能の変更や追加が可能
- 設計開発期間とコストの低減
- 製造コストの低減
  - 製造工場の規模縮小化
  - 製造工程での人的スキルの低減

<a id="content7"></a>
## 組込みエンジニア
- メーカー
  - 組込み機器メーカー
  - 組込みソフトウェアメーカー
  - 委託開発や派遣サービス

<a id="content8"></a>
## 組込みシステムの技術要素
- コンピュータ技術
- ソフトウェア
- 計測、制御技術
- 通信・ネットワーク技術

<a id="content9"></a>
## 応用システムの例(スマートフォン)
- 機能
  - 音声通話機能
  - メールやWeb接続機能
  - 音楽・動画等の再生・記録機能
  - PCで使われているオフィス機能

<a id="content10"></a>
## 応用システムで使用されている LSI
- CPU(アプリケーションプロセッサ)
  - スマートフォンではRISC型プロセッサが使われている。
- DSP(Digital Signal Processor)
  - デジタル信号処理専用のプロセッサ
    - 積和演算等を高速に処理できる。
  - 無線通信専用プロセッサ(ベースバンドプロセッサ)
    - 複数の無線システムに対応する。
- ASIC(Application Specific Integrated Circuit)
  - 特定機能向けのLSIであり、ある機能に特化した制御を行うハードウェアも集積している。
  - MPU、メモリ、DSP等を一つのチップに集積する。
    - 小型化・コスト・性能等の高機能化が可能である。
- FPGA(Field Programmable Gate Array)
  - PLD(Programmable Logic Device)の一種で、回路をプログラムで変更できる。
    - HDL(Hardware Description Language)で設計・開発を行う。
    - HDLで記述したライブラリを利用できる。

<a id="content11"></a>
## 応用システムの構成
- ハードウェア構成
  - アプリケーションプロセッサ(CPU)
    - RICS型プロセッサが使われている。
  - ベースバンドプロセッサ(DSP)等
- 二つのプロセッサを並列に動作させる。
  - 機能を分散する。
  - 時間制約の厳しい処理をユーザインタフェースから分離する。
    - CPUの性能・コストを低減し、低消費電力が期待できる。
    
<a id="content12"></a>
## 組込みシステム用 CPU
- 基本的な内部構成はPC用のCPPUと変わりはない。
- CPU(Central Processing Unit)の別名
  - プロセッサ(Processor)
  - マイコン(Micro Computer)
  - MPU(Micro Processing Unit)
  - ECU(Electronic)、主に自動車

<a id="content13"></a>
## CPUの分類(RISCとCISC)
- RISC(Reduced Instruction Set Computer)
  - 命令数を減らし(Reduced)、CPI(Clock Per Instruction)を低減する。
    - パイプライン下に適している。
  - スマートフォンではARMが主流である。
  - 省電力性能に優れている。
  - 性能向上のため、マルチプロセッサ(マルチコア)技術が使われている。
- CISC(Complex Instruction Set Computer)
  - 複雑な処理(Complex)dめお一つの命令で表す。
    - CPIが増加する。
  - Intel x64、AMD64が主に使われている。
    - 複雑な命令は、複数の単純な命令に置き換えて実行する。
  - 高性能だが消費電力が大きく、冷却装置が必要である。
  - PCも低消費電力が求められているので、マルチプロセッサ(マルチコア)技術が使われている。

<a id="content14"></a>
## 組込みシステム専用CPUチップの構成
- CPUコア
- 内臓RAM
  - 数kバイト~数100kバイト
- 内臓ROM
  - 一般にフラッシュメモリで構成されている。
  - 数100kバイト〜数Mバイト
- 多種・多数のI/Oインタフェース
  - 省スペース
  - 省電力
- 大量に作ることで安価にできる。
  - 組込むプログラムにより、多様な用途に対応できる。
  - 全てのI/Oインタフェースを使う必要はない。
    - 無駄でも、同じものを作った方が安価にできる。

<a id="content15"></a>
## 互換性・汎用性
- 以前はそれほど求められなかったが、現在は強く求められるようになってきた。
  - ソフトウェアの大規模化・複雑化が進んでる。
　   - 自動車やスマートフォンでは、500万〜1000万ステップのソフトウェアが搭載されている。
  - ソフトウェア開発の効率化が緊急の課題である。
- 例(スマートフォン)
  - CPUはRAM
  - OSはiOSとAndroid
  
<a id="content16"></a>
## タイマ(時間管理機能)
- リアルタイム処理に不可欠な時間管理を行うためのハードウェアである。
  - 複数のレジスタで制御されているタイマが組込まれている。
    - 経過時間を測定する。
    - タイマ割込みを発生させる。
- ウォッチドッグタイマ
  - ソフトウェアの状態を監視するタイマである。
  - 指定時間が経過すると割込みを発生する。
    - ソフトウェアで指定時間になる前にタイマをリセットする。

<a id="content17"></a>
## 省電力制御
- CPU、メモリ、周辺装置等のハードウェアの省電力制御が必要である。
  - 小型化・長時間駆動・冷却簡略化の要求が強い。
- MPUの省電力機能(省電力モード)
  - スタンバイ(スリープ)
    - MPUの命令実行を停止し、割込みにより省電力モードから復帰させる。
- サスペンド(ハイバネート、休止)
  - 動作クロックを停止して安全な停止状態にする。
  - 省電力効果は大きいが、復帰までに時間がかかる。
- メモリの省電力
  - DRAMのリフレッシュを止めて消費電力を抑える。
    - セルフリフレッシュモードの仕組みを使う。
- 周辺装置(デバイス)の省電力
  - デバイス制御レジスタで省電力モードに移行する。
    - デバイスの動作状態が失われ、再初期化が必要になる場合がある。
  - デバイスドライバが省電力モードに移行する前の状態を保持し、復帰後に復元する管理が必要である。

<a id="content18"></a>
## 組込みソフトウェア
- OSを使用しない場合もある。
  - メモリ容量の制約が厳しい場合。
  - 高いリアルタイム性が求められる場合。
- 機能の一部をハードウェアで実装する。
  - 高速化・高機能化を実現する。
    - ASIC(FPGA)により、CPUと共に1チップに実装する。
  - ハードウェアとソフトウェアの境界が曖昧になってきている。
    - C言語による論理設計も行われている。

<a id="content19"></a>
## リアルタイム性
- 単にスループットや応答時間が短いことをいうわけではない。
- システムが定められた時間要件を満たして動作する性質であるが…
  - 制限時間内に応答を返すことを保証しない。
  - 与えられたコンピュータ資源の範囲内で、最善の努力を行う。
- ハードリアルタイムline
  - 定められた時間(Deadline)までに、確実に処理を完了することが求められ、完了しないと深刻な影響が生じるリアルタイム性でる。
    - 車のエアバッグでは、確実に動作しないと乗員の生命に関わる。
- ソフトリアルタイム
  - 定められた時間までに処理を完了することが求められているが、完了しなくても、それほど深刻な影響は生じないリアルタイム性である。
    - 車のエンジンでは、一周期ぐらいミスファイアーしても、エンジンが止まることはない。

<a id="content20"></a>
## リアルタイム性の課題の解決
- 優先度(Priority)
  - 緊急度ともいう。
  - プログラム(タスク)の制限時間に応じて、処理に優先度を持たせる。
    - 制限時間が短いタスクの優先度を高くする。
  - スケジューラ(スケジューリングアルゴリズム)に実装されている。
    - 優先度制御
    - FCFS(First Come First Saved)制御

<a id="content21"></a>
## リアムタイムオペレーティングシステム
- リアルタイムオペレーティングシステム(RTOS)
  - リアルタイム性の保証が最重要課題のOSである。
    - リアルタイム性が保証できなければ、他の機能を犠牲にしても良い。
  - 汎用OSのような資源の抽象化や仮想化は不十分であり、CPUコアの緩い抽象化にとどまっている。
    - 幅広いハードウェアに対応する必要がある。
    - リアルタイム性が最優先である。
- 組込みシステムのOSは、リアルタイムOSが主流である。
  - OSを使用しない小規模なシステムもある。
  - WindowsやLiunxを流用することもある。
    - 欠点は、仮想記憶システムが必須であり、多くのメモリを必要とする。
- リアルタイムOSの種類
  - μITRON、ATK、OSEN/VDK、VxWORKS

<a id="content22"></a>
## μITRON仕様RTOS
- 組込みシステム用リアルタイムOSとそれに関する仕様である。
  - μITRON4.0仕様が規定されている。
  - 多数の組込み用プロセッサに対応している。
  - 国内で最も広く使われている。
  - 自由に実装できるオープンな仕様である。

<a id="content23"></a>
## 組込みシステム開発
- 汎用のシステム開発と異なり、多くの制約条件が存在する。
  - プラットフォームに起因する制約
    - 自由度が広いため、複雑なシステムはRTOSを使用するが、単純なシステムでは、OSを使用しない等。
  - ハードウェアに起因する制約
    - 重量、サイズ、消費電力等の制約がある。
  - 実世界との関係に起因する制約
    - 幅広い外部環境(温度・気圧等)に対応する必要がある。

<a id="content24"></a>
## 組込みソフトウェア開発
- 組込みシステムの高度化・多機能化・大規模化と共に、汎用システムの開発技術を適用することが必要になってきた。

<a id="content25"></a>
## 開発モデル
- ウォーターフォールモデル
  - 開発を複数の工程に分割し、各工程を完璧に仕上げ、「水が流れ落ちる」に次の工程へ進んでゆく手法である。
- 反復開発(スパイラル)モデル
  - 前工程への手戻りがあることを前提に、次工程からフィードバックを考慮したモデルである。
- オブジェクト指向モデル
  - オブジェクト指向言語(C++,Java等)から発達したモデルである。
  - 記述方法としては、UML(Unified Modeling Language)が多用されている。
- プロトタイピングモデル
  - 要求定義のユーザインタフェースやアルゴリズム、動作などの検証のために、開発の初期段階でかりのシステムを作成する。
  - 各機能のユーザによる妥当性の評価を受けて機能追加、改善を行う。

<a id="content26"></a>
## コーディングガイドライン
- プログラムの作成方法をルール化して、それに沿ったプログラミングをすることで、品質の向上につなげる手法である。
- MISRA-C
  - The Motor Industry Software Reliability Associationが策定した。
    - 車載ソフトウェアの信頼性を確保するためのC言語のコーディングガイドラインである。
    - プログラムがルールに従って作成されているか自動的にチェックするツールもある。

<a id="content27"></a>
## テスト技術
- ウォークスルー
  - 開発関係者が集まって、意見交換を行う。
- コードインスペクション
  - レビューの一種で、コードの良否を判定する。
  - 文法(ガイドライン)チェックツールなども活用する。
- ホワイトボックステスト
- ブラックボックステスト
- 結合テスト
- 性能・負荷テスト

<a id="content28"></a>
## ホワイトボックステスト
- プログラムの処理内容に従って、意図したとおりに作成されているかを確認するテストである。
- 網羅率(コードカバレッジ率)で検証の確かさを測定する。

<a id="content29"></a>
## ブラックボックステスト
- プログラムの処理内容に着目せず、多様なデータ・状況を作り出し、入力と実行結果から、設計・仕様通りに動作していることを確認する。
  - テストケース(条件)・テスト仕様書を作成する。
    - 設計書や要求仕様書から試験項目を策定する。
    - 試験に必要な環境・入力を記述する。
    - 予想される結果の正誤を的確に記述する。
  - テストケースに従ってテストを実施する。
    - 結果の正誤を正しく記述する。
    - 特に、誤った動作が発生する手順を克明に記述し、修正時に、誤った動作を再現できるようにする。

<a id="content30"></a>
## セルフ開発環境
- Windows用のプログラムは、Windows上で開発するのが一般的である。
  - CPUやハードウェア環境はほぼ同一である。

<a id="content31"></a>
## クロス開発環境
- 組込みソフトウェアを開発するシステムと、組込みソフトウェアを実行するシステムが異なる環境である。
  - 組込みソフトウェアは、WindowsやUNIX等の汎用OS上で開発するのが一般的である。
- 組込みソフトウェアを、組込みシステムで開発することは、ほぼ考えられない。
  - 組込みシステムにはWindowsのようなユーザインタフェースや資源がない。
    - CPUが異なっている。
    - メモリ容量が十分でない。
    - I/O装置、外部記憶装置がない。

<a id="content32"></a>
## ホストシステム
- ホストコンピュータ、ホストマシン等。
- 総合開発環境IDE(Integrarted Development Environment)を使用するのが一般的である。
  - 組込みソフトウェアのコーディング・コンパイル・リンクし、実行可能モジュールを作成する。
    - ターゲットシステムのオブジェクトコードを出力できるクラスコンパイラ、クロスアセンブラを利用する。
  - JTAG等によりターゲットシステムに接続する。
    - 実行可能モジュールをターゲットに転送し実行する。
  - TECL01/02ではCS+を使用する。

<a id="content33"></a>
## ターゲットシステム
- ターゲットコンピュータ、ターゲットボード等。
  - ソフトウェアシミュレータを使うこともある。
- ホストシステムで作成された実行可能モジュールを実行する。

<a id="content34"></a>
## デバッグ支援機器
- ホストシステムで作成した実行可能モジュールを、ターゲットシステムに転送してデバッグの支援を行うための機器である。
  - JTAG(Joint European Test Action Group)

<a id="content35"></a>
## JTAGデバッガ
- 組込みシステムのデバッグを行うためのシリアル通信の規格である。



